# -*- coding: utf-8 -*-
# Generated by Django 1.10.1 on 2017-04-02 17:50
from __future__ import unicode_literals

from django.core.exceptions import ObjectDoesNotExist
from django.db import migrations, models
import django.db.models.deletion


def move_team_ranking_to_result(apps, schema_editor):
    GameSession = apps.get_model("previous", "GameSession")
    AdhocTeam = apps.get_model("previous", "AdhocTeam")
    Result = apps.get_model("previous", "Result")
    Game = apps.get_model("previous", "Game")
    db_alias = schema_editor.connection.alias
    # For every adhoc team, create a result:
    #  * pointing to the team
    #  * having team's ranking
    #  * pointing to to a game (position 0) within the team's gamesession
    for team in AdhocTeam.objects.using(db_alias).all():
        try:
          session = GameSession.objects.using(db_alias).get(id=team.result_id)
        except ObjectDoesNotExist:
          print('Skipping missing result #%s' % (team.result_id))
          continue
        
        #team.session = team.result_id
        team.session = session.id
        team.save()
        
        if session is None:
          continue
        games = Game.objects.filter(session=session)
        if len(games) > 1:
          raise Exception("More games in session than expected")
        if len(games) == 1:
          game = games[0]
        if len(games) == 0:
          game = Game.objects.using(db_alias).create(
              datetime=session.datetime,
              submittor=session.submittor,
              session=session,
              position=0
          )
        Result.objects.using(db_alias).create(
            datetime=session.datetime,
            submittor=session.submittor,
            game=game, team=team,
            ranking=team.ranking
        )


def do_nothing(apps, schema_editor):
    pass



class Migration(migrations.Migration):

    dependencies = [
        ('previous', '0003_game_result'),
    ]

    operations = [
#        migrations.RenameField(
#            model_name='AdhocTeam',
#            old_name='result_id',
#            new_name='session',
#        ),
        migrations.RunPython(move_team_ranking_to_result, do_nothing),
        migrations.AlterField(
            model_name='adhocteam',
            name='session',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.DO_NOTHING, to='previous.GameSession'),
        ),
        migrations.RemoveField(
            model_name='adhocteam',
            name='result_id'
        ),
        migrations.RemoveField(
            model_name='adhocteam',
            name='ranking'
        ),
    ]
